@model LearningManagementSystem.Models.CourseListPageLoad

<style>
    .multi-box {
        position: relative;
        border: 1px solid #d0d7de;
        border-radius: 8px;
        padding: 6px;
        background: #fff;
        cursor: pointer;
    }

        .multi-box .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .multi-box .tag {
            background: #06BBCC;
            color: #fff;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .multi-box .tag span {
                cursor: pointer;
                font-size: 14px;
                line-height: 12px;
            }

        .multi-box .multi-input {
            border: none;
            outline: none;
            width: 100%;
            padding: 4px;
            margin-top: 4px;
            font-size: 13px;
        }

        .multi-box .multi-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 180px;
            overflow-y: auto;
            background: white;
            border: 1px solid #d0d7de;
            border-radius: 8px;
            margin-top: 4px;
            z-index: 99999;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .multi-box .multi-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }

            .multi-box .multi-item:hover {
                background-color: #eefcfc;
            }
</style>

<div class="container-xxl py-5">
    <div class="container">

        <div class="text-center mb-5">
            <h6 class="section-title bg-white text-primary d-inline-block px-3">Courses</h6>
            <h1 class="fw-bold mt-3">Explore Our Popular Courses</h1>
            <p class="text-muted">Browse top-rated courses tailored to your goals and interests.</p>
        </div>

        <div class="row g-4 border">

            <!-- FILTER SIDEBAR -->
            <div class="col-lg-3 col-md-4">
                <div class="position-sticky" style="top: 90px;">

                    <form id="filterForm" class="bg-light border rounded-3 p-0 shadow-sm"
                          style="max-height: 85vh; overflow-y: auto;">
                        <div class="p-3 border-bottom bg-white sticky-top">
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary rounded-pill btn-sm w-50" type="submit">Apply</button>
                                <button class="btn btn-outline-primary rounded-pill btn-sm w-50" type="button" id="resetFiltersBtn">Reset</button>
                            </div>
                        </div>

                        <div class="p-4">
                            <label class="filter-label">Popularity</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="popularity" value="popular">
                                <label class="form-check-label">Most Popular</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="popularity" value="free">
                                <label class="form-check-label">Free Courses</label>
                            </div>

                            <label class="filter-label">Course Type</label>
                            <div class="multi-box" id="courseTypeBox">
                                <div class="tag-container"></div>
                                <input type="text" class="multi-input" placeholder="Select Course Types">
                                <div class="multi-dropdown">
                                    @foreach (var item in Model.courseMasterList)
                                    {
                                        <div class="multi-item" data-id="@item.CourseMasterId">@item.CourseMasterType</div>
                                    }
                                </div>
                            </div>
                            <input type="hidden" id="courseTypes" name="courseTypes" />

                            <label class="filter-label mt-3">Skills</label>
                            <div class="multi-box" id="skillBox">
                                <div class="tag-container"></div>
                                <input type="text" class="multi-input" placeholder="Select Skills">
                                <div class="multi-dropdown">
                                    @foreach (var s in Model.skillsList)
                                    {
                                        <div class="multi-item" data-id="@s.SkillId">@s.SkillName</div>
                                    }
                                </div>
                            </div>
                            <input type="hidden" id="skills" name="skills" />

                            <!-- Additional filter fields (text inputs) -->
                            <div class="mt-3">
                                <label class="filter-label">Course Name</label>
                                <input type="text" class="form-control form-control-sm" id="courseName" name="courseName" />
                            </div>
                            <div class="mt-3">
                                <label class="filter-label">Provider</label>
                                <input type="text" class="form-control form-control-sm" id="provider" name="provider" />
                            </div>
                            <!--<div class="mt-3">
                                <label class="filter-label">Status</label>-->
                                @*<input type="text" class="form-control form-control-sm" id="status" name="status" />*@
                                <!--<select class="form-control form-control-sm" id="provider">
                                    <option value="-1">Select skills</option>
                                    <option value="1">Active</option>
                                    <option value="0">Inactive</option>
                                </select>
                            </div>-->

                            <input type="hidden" id="selectedCategoryId" value="@ViewBag.SelectedCategoryId" />
                        </div>
                    </form>
                </div>
            </div>

            <!-- COURSE LIST -->
            <div class="col-lg-9 col-md-8">
                <div id="courseContainer">
                    @Html.Partial("_CourseListPartial", (List<LearningManagementSystem.Models.CourseInfo>)ViewBag.CourseList)
                </div>
                <div class="mt-4 d-flex justify-content-center" id="pagination"></div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Read filter values from form and return an object
        function getFilters() {
            debugger
            return {
                id: $("#selectedCategoryId").val() || 0,
                courseName: $("#courseName").val() || "",
                provider: $("#provider").val() || "",
                status: $("#status").val() || "",
                courseTypes: $("#courseTypes").val() || "",
                skills: $("#skills").val() || ""
            };
        }

        // Load page with filters applied
        function loadPage(page) {
            debugger
            var filters = getFilters();
            filters.page = page || 1;
            filters.pageSize = 3;

            $.ajax({
                url: '@Url.Action("GetPagedCourses", "CourseList")',
                type: 'GET',
                data: filters,
                success: function (html) {
                    $("#courseContainer").html(html);

                    // After partial renders, we need to regenerate the central pagination (if desired)
                    // but partial now contains pagination markup as well.
                    // If you want to keep the global pagination element, you can parse metadata from server.
                },
                error: function () {
                    alert("Error loading courses.");
                }
            });
        }

        // MULTI-SELECT implementation (simple)
        function multiSelect(boxId, hiddenId) {
            let box = $(boxId);
            let input = box.find(".multi-input");
            let dropdown = box.find(".multi-dropdown");
            let container = box.find(".tag-container");
            let hidden = $(hiddenId);
            let selected = [];

            box.on("click", function (e) {
                e.stopPropagation();
                $(".multi-dropdown").not(dropdown).hide();
                dropdown.toggle();
            });

            input.on("keyup", function () {
                let val = $(this).val().toLowerCase();
                dropdown.children().each(function () {
                    $(this).toggle($(this).text().toLowerCase().includes(val));
                });
            });

            dropdown.on("click", ".multi-item", function (e) {
                e.stopPropagation();
                let id = $(this).data("id");
                let text = $(this).text();

                if (!selected.includes(id)) {
                    selected.push(id);
                    container.append(`
                        <div class="tag" data-id="${id}">
                            ${text} <span data-id="${id}">×</span>
                        </div>
                    `);
                }

                hidden.val(selected.join(","));
                input.val("");
                dropdown.hide();
            });

            container.on("click", "span", function (e) {
                e.stopPropagation();
                let id = $(this).data("id");
                selected = selected.filter(x => x !== id);
                hidden.val(selected.join(","));
                $(this).parent().remove();
            });

            $(document).on("click", function () {
                dropdown.hide();
            });
        }

        $(document).ready(function () {
            // initialize multi selects
            multiSelect("#courseTypeBox", "#courseTypes");
            multiSelect("#skillBox", "#skills");

            // On initial load request page 1 (ensures ViewBag.CourseList used for initial html is replaced with paged partial)
            loadPage(1);

            // Filter submit
            $("#filterForm").on("submit", function (e) {
                e.preventDefault();
                // Apply filters and load page 1
                loadPage(1);
            });

            // Reset button
            $("#resetFiltersBtn").on("click", function () {
                $("#filterForm")[0].reset();
                $("#courseTypes").val("");
                $("#skills").val("");
                $("#courseTypeBox .tag-container").empty();
                $("#skillBox .tag-container").empty();
                loadPage(1);
            });
        });
    </script>
}
